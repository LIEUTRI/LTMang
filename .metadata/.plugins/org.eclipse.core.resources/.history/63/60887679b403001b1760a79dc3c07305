package main;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.Serializable;
import java.net.Socket;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.text.DecimalFormatSymbols;
import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.util.Currency;
import java.util.Locale;
import java.util.Scanner;

public class ServerTask extends Thread implements Serializable  {
	private Socket s;
	private ServerTask instance;
	public ServerTask(Socket s){
		this.s = s;
	}
	public void run() {
		try {
			InputStream is = s.getInputStream();
			OutputStream os = s.getOutputStream();
			int check = 0;
			
			while(true) {
				byte[] b = new byte[1000];
				check = is.read(b);
				String cmd = new String(b).trim();
				String phonenumber = cmd.substring(0,cmd.indexOf(" "));
				String request = cmd.substring(cmd.indexOf(" ")+1, cmd.lastIndexOf(" "));
				String amount = cmd.substring(cmd.lastIndexOf(" ")+1);
				System.out.println("phone: "+phonenumber+", request: "+request+", amount: "+amount);
				
		        Locale locale = new Locale("vi", "VN");
		        Currency currency = Currency.getInstance("VND");

		        NumberFormat numberFormat = NumberFormat.getCurrencyInstance();
		        DecimalFormatSymbols dfs = new DecimalFormatSymbols();
		        dfs.setCurrencySymbol("VND");
		        dfs.setGroupingSeparator('.');
		        dfs.setMonetaryDecimalSeparator(',');
		        numberFormat.setMaximumFractionDigits(0);
		        ((DecimalFormat) numberFormat).setDecimalFormatSymbols(dfs);
		        				
				if(cmd.indexOf("RUT") >= 0) {
					updateAccountBalance(phonenumber, amount);
					String notify = "Amount: "+numberFormat.format(Double.parseDouble(amount))+"\n"+"Balance: "+numberFormat.format(Double.parseDouble(getAccountBalance(phonenumber)));
					os.write(notify.getBytes());
				} else if(cmd.indexOf("KT") >= 0) {
					String report = "Balance: " + numberFormat.format(Double.parseDouble(getAccountBalance(phonenumber)));
					os.write(report.getBytes());
				}
			}
		} catch (IOException e) {
		}
	}
	
	private String getAccountBalance(String phone) {
		File file = new File(new File("resources").getAbsolutePath()+"/account.txt");
		try {
			Scanner sc = new Scanner(file);
			while(sc.hasNextLine()) {
				String s = sc.nextLine().trim();
				if(s.indexOf(phone) >= 0) {
					return s.substring(s.indexOf("BALANCE")+7);
				}
			}
		} catch (FileNotFoundException e) {
			System.out.println("Error! File "+new File("resources").getAbsolutePath()+"/account.conf not found!");
		}
		return "";
	}
	
	private void updateAccountBalance(String phone, String amount) {
		File file = new File(new File("resources").getAbsolutePath()+"/account.txt");
		try {
			Scanner sc = new Scanner(file);
			while(sc.hasNextLine()) {
				String s = sc.nextLine().trim();
				if(s.indexOf(phone) >= 0) {
					String oldBalance = s.substring(s.indexOf("BALANCE")+7);
					String newBalance = (Integer.parseInt(oldBalance)-Integer.parseInt(amount))+"";
					
					Path path = Paths.get(new File("resources").getAbsolutePath()+"/account.txt");
					String content;
					try {
						content = new String(Files.readAllBytes(path), StandardCharsets.UTF_8);
						content = content.replace("PHONE"+phone+" BALANCE"+oldBalance, "PHONE"+phone+" BALANCE"+newBalance);
						Files.write(path, content.getBytes(StandardCharsets.UTF_8));
					} catch (IOException e) {
						e.printStackTrace();
					}
				}
			}
		} catch (FileNotFoundException e) {
			System.out.println("Error! File "+new File("resources").getAbsolutePath()+"/account.conf not found!");
		}
	}
}
